<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ Sơ - Cinema</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body class="bg-gray-100">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="../index.html" class="text-2xl font-bold">Cinema</a>
            <div class="space-x-4">
                <a href="../movies.html" class="hover:text-blue-200">Phim</a>
                <a href="../screenings.html" class="hover:text-blue-200">Lịch Chiếu</a>
                <a href="tickets.html" class="hover:text-blue-200">Vé Của Tôi</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <div class="max-w-2xl mx-auto">
            <h1 class="text-3xl font-bold mb-6">Hồ Sơ Của Tôi</h1>

            <div id="profile-container" class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center">
                    <div class="spinner mx-auto"></div>
                    <p class="mt-2">Đang tải thông tin...</p>
                </div>
            </div>

            <!-- Form cập nhật thông tin -->
            <div id="update-form" class="hidden bg-white rounded-lg shadow-lg p-6 mt-6">
                <h2 class="text-2xl font-bold mb-4">Cập Nhật Thông Tin</h2>
                <form id="profile-form" class="space-y-4">
                    <div>
                        <label for="fullName" class="block text-gray-700 mb-2">Họ và tên</label>
                        <input type="text" id="fullName" name="fullName" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="phone" class="block text-gray-700 mb-2">Số điện thoại</label>
                        <input type="tel" id="phone" name="phone" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="password" class="block text-gray-700 mb-2">Mật khẩu mới (để trống nếu không đổi)</label>
                        <input type="password" id="password" name="password" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="cancelUpdate()"
                                class="px-4 py-2 border rounded-lg hover:bg-gray-100">
                            Hủy
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Lưu thay đổi
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:8080';
        const token = localStorage.getItem('token');

        if (!token) {
            window.location.href = 'login.html';
        }

        function loadUserProfile() {
            fetch(`${API_URL}/api/users/profile`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Phiên đăng nhập đã hết hạn');
                    }
                    throw new Error('Không thể tải thông tin người dùng');
                }
                return response.json();
            })
            .then(user => {
                const container = document.getElementById('profile-container');
                container.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <p class="text-gray-600">Tên đăng nhập</p>
                            <p class="text-xl font-semibold">${user.username}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Họ và tên</p>
                            <p class="text-xl font-semibold">${user.fullName || 'Chưa cập nhật'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Email</p>
                            <p class="text-xl font-semibold">${user.email || 'Chưa cập nhật'}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Số điện thoại</p>
                            <p class="text-xl font-semibold">${user.phoneNumber || 'Chưa cập nhật'}</p>
                        </div>
                        <div class="pt-4">
                            <button onclick="showUpdateForm()"
                                    class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                                Cập nhật thông tin
                            </button>
                        </div>
                    </div>
                `;

                // Điền thông tin vào form
                document.getElementById('fullName').value = user.fullName || '';
                document.getElementById('phone').value = user.phoneNumber || '';
            })
            .catch(error => {
                console.error('Error:', error);
                if (error.message === 'Phiên đăng nhập đã hết hạn') {
                    window.location.href = 'login.html';
                } else {
                    document.getElementById('profile-container').innerHTML = `
                        <div class="text-center text-red-500">
                            <p>${error.message}</p>
                            <button onclick="loadUserProfile()"
                                    class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">
                                Thử lại
                            </button>
                        </div>
                    `;
                }
            });
        }

        function showUpdateForm() {
            document.getElementById('update-form').classList.remove('hidden');
        }

        function cancelUpdate() {
            document.getElementById('update-form').classList.add('hidden');
        }

        document.getElementById('profile-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const updateData = {
                fullName: document.getElementById('fullName').value,
                phoneNumber: document.getElementById('phone').value
            };

            // Chỉ thêm password vào request nếu người dùng nhập mật khẩu mới
            const password = document.getElementById('password').value;
            if (password.trim()) {
                updateData.password = password;
            }

            console.log('Sending update data:', updateData);

            fetch(`${API_URL}/api/users/profile`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(async response => {
                const text = await response.text();
                console.log('Response text:', text);

                if (!response.ok) {
                    throw new Error(text || 'Không thể cập nhật thông tin');
                }

                return text ? JSON.parse(text) : {};
            })
            .then(result => {
                console.log('Update successful:', result);
                alert('Cập nhật thông tin thành công!');
                cancelUpdate();
                loadUserProfile();
            })
            .catch(error => {
                console.error('Error details:', error);
                alert('Có lỗi xảy ra: ' + error.message);
            });
        });

        // Load user profile when page loads
        loadUserProfile();
    </script>
</body>
</html>