<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Cinema</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../../css/styles.css">
</head>
<body class="bg-gray-100">
    <nav class="bg-gray-800 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#" class="text-2xl font-bold">Cinema Admin</a>
            <div class="space-x-4">
                <a href="#" class="hover:text-gray-300" onclick="showSection('movies')">Quản lý Phim</a>
                <a href="#" class="hover:text-gray-300" onclick="showSection('screenings')">Quản lý Suất chiếu</a>
                <a href="#" class="hover:text-gray-300" onclick="showSection('users')">Quản lý Người dùng</a>
                <button onclick="logout()" class="hover:text-gray-300">Đăng xuất</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <!-- Movies Section -->
        <section id="movies-section" class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Quản lý Phim</h2>
                <button onclick="showAddMovieForm()"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Thêm Phim Mới
                </button>
            </div>

            <!-- Form thêm/sửa phim -->
            <div id="movie-form" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 id="form-title" class="text-xl font-bold mb-4">Thêm Phim Mới</h3>
                <form id="movieForm" class="space-y-4">
                    <input type="hidden" id="movieId">
                    <div>
                        <label for="title" class="block text-gray-700 mb-2">Tên phim</label>
                        <input type="text" id="title" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="genre" class="block text-gray-700 mb-2">Thể loại</label>
                        <input type="text" id="genre" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="director" class="block text-gray-700 mb-2">Đạo diễn</label>
                        <input type="text" id="director" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="movieCast" class="block text-gray-700 mb-2">Diễn viên</label>
                        <input type="text" id="movieCast" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="duration" class="block text-gray-700 mb-2">Thời lượng (phút)</label>
                        <input type="number" id="duration" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="releaseDate" class="block text-gray-700 mb-2">Ngày khởi chiếu</label>
                        <input type="date" id="releaseDate" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="description" class="block text-gray-700 mb-2">Mô tả</label>
                        <textarea id="description" rows="4" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                    <div>
                        <label for="status" class="block text-gray-700 mb-2">Trạng thái</label>
                        <select id="status" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Đang tải trạng thái...</option>
                        </select>
                    </div>
                    <div>
                        <label for="posterFile" class="block text-gray-700 mb-2">Poster phim</label>
                        <input type="file" id="posterFile" accept="image/*" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="hideMovieForm()"
                                class="px-4 py-2 border rounded-lg hover:bg-gray-100">
                            Hủy
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Lưu
                        </button>
                    </div>
                </form>
            </div>

            <div id="movies-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="spinner mx-auto"></div>
                    <p class="mt-2">Đang tải danh sách phim...</p>
                </div>
            </div>
        </section>

        <!-- Screenings Section -->
        <section id="screenings-section" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Quản lý Suất chiếu</h2>
                <button onclick="showAddScreeningForm()"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Thêm Suất Chiếu
                </button>
            </div>

            <!-- Form thêm/sửa suất chiếu -->
            <div id="screening-form" class="hidden bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 id="screening-form-title" class="text-xl font-bold mb-4">Thêm Suất Chiếu</h3>
                <form id="screeningForm" class="space-y-4">
                    <input type="hidden" id="screeningId">
                    <div>
                        <label for="movieSelect" class="block text-gray-700 mb-2">Phim</label>
                        <select id="movieSelect" required class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Chọn phim...</option>
                        </select>
                    </div>
                    <div>
                        <label for="startTime" class="block text-gray-700 mb-2">Thời gian bắt đầu</label>
                        <input type="datetime-local" id="startTime" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="hallNumber" class="block text-gray-700 mb-2">Phòng chiếu</label>
                        <input type="text" id="hallNumber" required class="w-full px-3 py-2 border rounded-lg" placeholder="Ví dụ: Hall A">
                    </div>
                    <div>
                        <label for="availableSeats" class="block text-gray-700 mb-2">Số ghế trống</label>
                        <input type="number" id="availableSeats" required min="1" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label for="price" class="block text-gray-700 mb-2">Giá vé (VND)</label>
                        <input type="number" id="price" required min="0" step="1000" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" onclick="hideScreeningForm()"
                                class="px-4 py-2 border rounded-lg hover:bg-gray-100">
                            Hủy
                        </button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            Lưu
                        </button>
                    </div>
                </form>
            </div>

            <div id="screenings-list" class="space-y-4">
                <div class="text-center">
                    <div class="spinner mx-auto"></div>
                    <p class="mt-2">Đang tải danh sách suất chiếu...</p>
                </div>
            </div>
        </section>

        <!-- Users Section -->
        <section id="users-section" class="hidden space-y-6">
            <h2 class="text-2xl font-bold">Quản lý Người dùng</h2>
            <div id="users-list" class="space-y-4">
                <div class="text-center">
                    <div class="spinner mx-auto"></div>
                    <p class="mt-2">Đang tải danh sách người dùng...</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        const API_URL = 'http://localhost:8080';
        const token = localStorage.getItem('token');

        // Kiểm tra quyền admin
        function checkAdminAccess() {
            if (!token) {
                window.location.href = '../login.html';
                return;
            }

            fetch(`${API_URL}/api/users/profile`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(user => {
                console.log('User roles:', user.roles); // Log để debug
                if (!user.roles || !user.roles.includes('ROLE_ADMIN')) {
                    alert('Bạn không có quyền truy cập trang này!');
                    window.location.href = '../../index.html';
                }
                // Lưu thông tin user để sử dụng sau này
                window.currentUser = user;
            })
            .catch(error => {
                console.error('Error checking admin access:', error);
                window.location.href = '../login.html';
            });
        }

        function showSection(sectionName) {
            // Ẩn tất cả các section
            document.getElementById('movies-section').classList.add('hidden');
            document.getElementById('screenings-section').classList.add('hidden');
            document.getElementById('users-section').classList.add('hidden');

            // Hiển thị section được chọn
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');

            // Load dữ liệu cho section
            switch(sectionName) {
                case 'movies':
                    loadMovies();
                    break;
                case 'screenings':
                    loadScreenings();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
        }

        function loadMovies() {
            const moviesList = document.getElementById('movies-list');
            moviesList.innerHTML = `
                <div class="col-span-full text-center">
                    <div class="spinner mx-auto"></div>
                    <p class="mt-2">Đang tải danh sách phim...</p>
                </div>
            `;

            return fetch(`${API_URL}/api/movies/public/all`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không thể tải danh sách phim');
                    }
                    return response.json();
                })
                .then(movies => {
                    if (Array.isArray(movies) && movies.length > 0) {
                        moviesList.innerHTML = movies.map(movie => `
                            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                                <img src="${movie.posterUrl ? `${API_URL}/${movie.posterUrl.replace(/^\//, '')}` : `${API_URL}/images/movie-posters/default.jpg`}"
                                     alt="${movie.title}"
                                     class="w-full h-48 object-cover"
                                     onerror="this.src='${API_URL}/images/movie-posters/default.jpg'">
                                <div class="p-4">
                                    <h3 class="text-xl font-semibold mb-2">${movie.title}</h3>
                                    <p class="text-gray-600 mb-2">${movie.genre || 'Chưa cập nhật'}</p>
                                    <p class="text-gray-600 mb-2">Thời lượng: ${movie.duration || 0} phút</p>
                                    <div class="flex justify-end space-x-2">
                                        <button onclick="editMovie(${movie.id})"
                                                class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                            Sửa
                                        </button>
                                        <button onclick="deleteMovie(${movie.id})"
                                                class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                            Xóa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        moviesList.innerHTML = `
                            <div class="col-span-full text-center text-gray-500">
                                <p>Chưa có phim nào.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    moviesList.innerHTML = `
                        <div class="col-span-full text-center text-red-500">
                            <p>Có lỗi xảy ra khi tải danh sách phim: ${error.message}</p>
                            <button onclick="loadMovies()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">
                                Thử lại
                            </button>
                        </div>
                    `;
                });
        }

        function loadScreenings() {
            // Lấy thời gian từ 1 năm trước đến 1 năm sau
            const startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 1);
            const endDate = new Date();
            endDate.setFullYear(endDate.getFullYear() + 1);

            fetch(`${API_URL}/api/screenings/date-range?start=${startDate.toISOString()}&end=${endDate.toISOString()}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể tải danh sách suất chiếu');
                }
                return response.json();
            })
            .then(screenings => {
                const screeningsList = document.getElementById('screenings-list');
                if (Array.isArray(screenings) && screenings.length > 0) {
                    // Sắp xếp suất chiếu theo thời gian, mới nhất lên đầu
                    screenings.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

                    screeningsList.innerHTML = screenings.map(screening => `
                        <div class="bg-white rounded-lg shadow-lg p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-semibold">${screening.movieTitle}</h3>
                                    <p class="text-gray-600">Thời gian: ${new Date(screening.startTime).toLocaleString()}</p>
                                    <p class="text-gray-600">Phòng: ${screening.hallNumber}</p>
                                    <p class="text-gray-600">Số ghế trống: ${screening.availableSeats}</p>
                                    <p class="text-gray-600">Giá vé: ${screening.price.toLocaleString('vi-VN')} VND</p>
                                </div>
                                <div class="space-x-2">
                                    <button onclick="editScreening(${screening.id})"
                                            class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                        Sửa
                                    </button>
                                    <button onclick="deleteScreening(${screening.id})"
                                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                        Xóa
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    screeningsList.innerHTML = `
                        <div class="text-center text-gray-500">
                            <p>Chưa có suất chiếu nào.</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('screenings-list').innerHTML = `
                    <div class="text-center text-red-500">
                        <p>Có lỗi xảy ra khi tải danh sách suất chiếu: ${error.message}</p>
                        <button onclick="loadScreenings()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">
                            Thử lại
                        </button>
                    </div>
                `;
            });
        }

        function loadUsers() {
            fetch(`${API_URL}/api/users`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(users => {
                const usersList = document.getElementById('users-list');
                usersList.innerHTML = users.map(user => `
                    <div class="bg-white rounded-lg shadow-lg p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-semibold">${user.username}</h3>
                                <p class="text-gray-600">Email: ${user.email}</p>
                                <p class="text-gray-600">Vai trò: ${user.roles.join(', ')}</p>
                            </div>
                            <div class="space-x-2">
                                <button onclick="toggleUserStatus(${user.id})"
                                        class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">
                                    ${user.enabled ? 'Khóa' : 'Mở khóa'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('users-list').innerHTML = `
                    <div class="text-center text-red-500">
                        <p>Có lỗi xảy ra khi tải danh sách người dùng.</p>
                        <button onclick="loadUsers()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">
                            Thử lại
                        </button>
                    </div>
                `;
            });
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '../login.html';
        }

        function showAddMovieForm() {
            document.getElementById('form-title').textContent = 'Thêm Phim Mới';
            document.getElementById('movieId').value = '';
            document.getElementById('movieForm').reset();
            document.getElementById('movie-form').classList.remove('hidden');
            loadMovieStatuses(); // Load danh sách trạng thái
        }

        function hideMovieForm() {
            document.getElementById('movie-form').classList.add('hidden');
            document.getElementById('movieForm').reset();
        }

        function loadMovieStatuses() {
            fetch(`${API_URL}/api/movies/statuses`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể tải danh sách trạng thái');
                }
                return response.json();
            })
            .then(statuses => {
                const statusSelect = document.getElementById('status');
                statusSelect.innerHTML = statuses.map(status =>
                    `<option value="${status.value}">${status.label}</option>`
                ).join('');
            })
            .catch(error => {
                console.error('Error loading statuses:', error);
                document.getElementById('status').innerHTML = '<option value="">Lỗi tải trạng thái</option>';
            });
        }

        function editMovie(movieId) {
            // Lấy thông tin phim cần sửa từ API public
            fetch(`${API_URL}/api/movies/public/${movieId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không thể tải thông tin phim');
                    }
                    return response.json();
                })
                .then(movie => {
                    console.log('Movie data:', movie); // Log để debug
                    // Lưu thông tin phim vào form để sử dụng sau này
                    window.currentMovie = movie;

                    document.getElementById('form-title').textContent = 'Sửa Phim';
                    document.getElementById('movieId').value = movie.id;
                    document.getElementById('title').value = movie.title || '';
                    document.getElementById('genre').value = movie.genre || '';
                    document.getElementById('director').value = movie.director || '';
                    document.getElementById('movieCast').value = movie.cast || '';
                    document.getElementById('duration').value = movie.duration || '';
                    document.getElementById('releaseDate').value = movie.releaseDate ? movie.releaseDate.split('T')[0] : '';
                    document.getElementById('description').value = movie.description || '';

                    // Load danh sách trạng thái và set giá trị
                    loadMovieStatuses();
                    setTimeout(() => {
                        document.getElementById('status').value = movie.status;
                    }, 500);

                    document.getElementById('movie-form').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error fetching movie:', error);
                    alert('Có lỗi xảy ra khi tải thông tin phim: ' + error.message);
                });
        }

        function deleteMovie(movieId) {
            if (confirm('Bạn có chắc chắn muốn xóa phim này?')) {
                const movieElement = document.querySelector(`[onclick="deleteMovie(${movieId})"]`).closest('.bg-white');
                movieElement.innerHTML = `
                    <div class="p-4 text-center">
                        <div class="spinner mx-auto"></div>
                        <p class="mt-2">Đang xóa phim...</p>
                    </div>
                `;

                fetch(`${API_URL}/api/movies/${movieId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(async response => {
                    if (!response.ok) {
                        throw new Error(await response.text() || 'Không thể xóa phim');
                    }
                    // Đợi một chút trước khi reload
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    alert('Xóa phim thành công');
                    await loadMovies();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa phim: ' + error.message);
                    loadMovies(); // Reload to restore the view
                });
            }
        }

        // Xử lý submit form thêm/sửa phim
        document.getElementById('movieForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Disable submit button to prevent double submission
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...';

            try {
                // Kiểm tra lại quyền admin trước khi thực hiện thao tác
                if (!window.currentUser || !window.currentUser.roles || !window.currentUser.roles.includes('ROLE_ADMIN')) {
                    alert('Bạn không có quyền thực hiện thao tác này!');
                    return;
                }

                const movieId = document.getElementById('movieId').value;
                const posterFile = document.getElementById('posterFile').files[0];

                if (movieId) {
                    // Xử lý cập nhật phim
                    const movieData = {
                        title: document.getElementById('title').value,
                        genre: document.getElementById('genre').value,
                        director: document.getElementById('director').value,
                        movieCast: document.getElementById('movieCast').value,
                        duration: parseInt(document.getElementById('duration').value),
                        releaseDate: document.getElementById('releaseDate').value,
                        description: document.getElementById('description').value,
                        status: document.getElementById('status').value
                    };

                    if (window.currentMovie && window.currentMovie.posterUrl) {
                        movieData.posterUrl = window.currentMovie.posterUrl;
                    }

                    // Cập nhật thông tin phim
                    const updateResponse = await fetch(`${API_URL}/api/movies/${movieId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(movieData)
                    });

                    if (!updateResponse.ok) {
                        throw new Error(await updateResponse.text() || 'Không thể cập nhật phim');
                    }

                    // Nếu có file poster mới, cập nhật poster riêng
                    if (posterFile) {
                        const formData = new FormData();
                        formData.append('posterFile', posterFile);

                        const posterResponse = await fetch(`${API_URL}/api/movies/${movieId}/poster`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });

                        if (!posterResponse.ok) {
                            console.warn('Poster upload failed but movie data was updated');
                        }
                    }

                    alert('Cập nhật phim thành công!');
                } else {
                    // Thêm phim mới
                    const formData = new FormData();
                    formData.append('title', document.getElementById('title').value);
                    formData.append('genre', document.getElementById('genre').value);
                    formData.append('director', document.getElementById('director').value);
                    formData.append('movieCast', document.getElementById('movieCast').value);
                    formData.append('duration', document.getElementById('duration').value);
                    formData.append('releaseDate', document.getElementById('releaseDate').value);
                    formData.append('description', document.getElementById('description').value);
                    formData.append('status', document.getElementById('status').value);

                    if (posterFile) {
                        formData.append('posterFile', posterFile);
                    }

                    const response = await fetch(`${API_URL}/api/movies`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Server response:', errorText);

                        if (response.status === 401) {
                            alert('Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại!');
                            window.location.href = '../login.html';
                            return;
                        }

                        if (response.status === 403) {
                            alert('Bạn không có quyền thực hiện thao tác này!');
                            return;
                        }

                        throw new Error(errorText || 'Không thể thêm phim mới. Vui lòng kiểm tra kết nối và thử lại!');
                    }

                    alert('Thêm phim mới thành công');
                }

                // Đợi một chút trước khi reload để đảm bảo server đã xử lý xong
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideMovieForm();

                // Thử load lại danh sách phim tối đa 3 lần
                let retryCount = 0;
                const maxRetries = 3;

                while (retryCount < maxRetries) {
                    try {
                        await loadMovies();
                        break; // Nếu load thành công thì thoát vòng lặp
                    } catch (error) {
                        console.warn(`Lần thử ${retryCount + 1}: Không thể tải lại danh sách phim`, error);
                        retryCount++;
                        if (retryCount === maxRetries) {
                            console.error('Không thể tải lại danh sách phim sau nhiều lần thử');
                            // Không hiển thị thông báo lỗi cho người dùng vì phim đã được lưu thành công
                        }
                        // Đợi 1 giây trước khi thử lại
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra: ' + error.message);
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Lưu';
            }
        });

        // Các hàm xử lý quản lý xuất chiếu
        function showAddScreeningForm() {
            document.getElementById('screening-form-title').textContent = 'Thêm Suất Chiếu';
            document.getElementById('screeningId').value = '';
            document.getElementById('screeningForm').reset();
            document.getElementById('screening-form').classList.remove('hidden');
            loadMoviesForSelect();
        }

        function hideScreeningForm() {
            document.getElementById('screening-form').classList.add('hidden');
            document.getElementById('screeningForm').reset();
        }

        function loadMoviesForSelect() {
            fetch(`${API_URL}/api/movies/public/all`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể tải danh sách phim');
                }
                return response.json();
            })
            .then(movies => {
                if (!Array.isArray(movies)) {
                    throw new Error('Dữ liệu phim không hợp lệ');
                }
                const movieSelect = document.getElementById('movieSelect');
                movieSelect.innerHTML = '<option value="">Chọn phim...</option>' +
                    movies.map(movie => `<option value="${movie.id}">${movie.title}</option>`).join('');
            })
            .catch(error => {
                console.error('Error loading movies:', error);
                const movieSelect = document.getElementById('movieSelect');
                movieSelect.innerHTML = '<option value="">Lỗi tải danh sách phim</option>';
                alert('Có lỗi xảy ra khi tải danh sách phim: ' + error.message);
            });
        }

        function editScreening(screeningId) {
            fetch(`${API_URL}/api/screenings/${screeningId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Không thể tải thông tin suất chiếu');
                }
                return response.json();
            })
            .then(screening => {
                document.getElementById('screening-form-title').textContent = 'Sửa Suất Chiếu';
                document.getElementById('screeningId').value = screening.id;

                // Load danh sách phim và chọn phim hiện tại
                loadMoviesForSelect();
                setTimeout(() => {
                    document.getElementById('movieSelect').value = screening.movieId;
                }, 500);

                // Format datetime-local input
                const startTime = new Date(screening.startTime);
                const formattedDateTime = startTime.toISOString().slice(0, 16);
                document.getElementById('startTime').value = formattedDateTime;

                document.getElementById('hallNumber').value = screening.hallNumber;
                document.getElementById('availableSeats').value = screening.availableSeats;
                document.getElementById('price').value = screening.price;
                document.getElementById('screening-form').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tải thông tin suất chiếu: ' + error.message);
            });
        }

        function deleteScreening(screeningId) {
            if (confirm('Bạn có chắc chắn muốn xóa suất chiếu này?')) {
                fetch(`${API_URL}/api/screenings/${screeningId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Không thể xóa suất chiếu');
                    }
                    alert('Xóa suất chiếu thành công');
                    loadScreenings();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa suất chiếu: ' + error.message);
                });
            }
        }

        // Xử lý submit form thêm/sửa suất chiếu
        document.getElementById('screeningForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...';

            try {
                if (!window.currentUser || !window.currentUser.roles || !window.currentUser.roles.includes('ROLE_ADMIN')) {
                    alert('Bạn không có quyền thực hiện thao tác này!');
                    return;
                }

                const screeningId = document.getElementById('screeningId').value;
                const screeningData = {
                    movieId: parseInt(document.getElementById('movieSelect').value),
                    startTime: new Date(document.getElementById('startTime').value).toISOString(),
                    hallNumber: document.getElementById('hallNumber').value,
                    availableSeats: parseInt(document.getElementById('availableSeats').value),
                    price: parseInt(document.getElementById('price').value)
                };

                // Nếu là cập nhật, thêm id vào data
                if (screeningId) {
                    screeningData.id = parseInt(screeningId);
                }

                // Luôn sử dụng POST cho cả thêm mới và cập nhật
                const response = await fetch(`${API_URL}/api/screenings`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(screeningData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Không thể ${screeningId ? 'cập nhật' : 'thêm'} suất chiếu`);
                }

                alert(`${screeningId ? 'Cập nhật' : 'Thêm'} suất chiếu thành công!`);
                hideScreeningForm();
                loadScreenings();

            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Lưu';
            }
        });

        // Kiểm tra quyền admin khi tải trang
        checkAdminAccess();
        // Mặc định hiển thị section phim
        showSection('movies');
    </script>
</body>
</html>